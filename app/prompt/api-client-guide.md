# API Client Complete Guide

## Overview

The API Client is auto-generated by the `openapi-ts` tool. The source Swagger file is located at `../docs/swagger/swagger.json`, and the generated client is located at `./app/data/generated-http-client`.

The Swagger-generated client resides in `app/data/generated-http-client`, with an additional wrapper layer in `app/data/http-client`.
When the Swagger specification changes, always use the latest client under `app/data/generated-http-client`.

## Tool Data Interaction

Tool data storage is handled through `IToolRepository`. The current implementation is `LocalToolRepository`, which stores Tool data in localStorage.

## Domain Repository Convention

When defining a Repository for any domain data (e.g., User, Tool, Script), follow this unified approach:

- **Entity Definition**: Define an `interface` for the domain object in `app/entity/`, including only the fields required by the business logic, and keep field naming consistent with the consuming side.
- **Repository Interface**: Create `IXXXRepository` in `app/data/interface/`, exposing only the methods needed by the domain. Return types should uniformly use the corresponding `Entity`.
- **HTTP Implementation**: Implement `HttpXXXRepository` in `app/data/repository/`, calling the Swagger functions from `app/data/generated-http-client`. Complete the DTO -> Entity mapping and necessary field validation/trimming within the implementation.
- **Dependency Injection**: Register the repository instance in `app/di/global-di.ts`, allowing upper layers (Context/components/services) to consume it via DI rather than calling the Swagger client directly.
- **In-Memory Strategy**: For sensitive data such as user information, store it only in memory (state/context) without writing to localStorage, to avoid state persistence and stale data issues.

## Swagger Change Impact Scope and Modification Checklist

When the Swagger API documentation changes (especially Tool-related data structure changes), follow the process below to update accordingly.

### Swagger Change Workflow

1. **Regenerate HTTP Client**: Use the `openapi-ts` tool to regenerate the code under `app/data/generated-http-client`
2. **Check Impact Scope**: Based on the type of change, follow the checklist below to make modifications

### Impact Scope of Tool Data Structure Changes

When the Tool data structure changes (e.g., adding new fields, modifying field types, changing API endpoints), the following files need to be checked and modified:

#### Core Type Definitions
- **`app/entity/tool.ts`** - Tool interface definition
  - Add/modify/remove fields
  - Update related type definitions and utility functions

#### Repository Layer (Data Access)
- **`app/data/interface/i-tool-repository.ts`** - IToolRepository interface
  - Update interface method signatures if API parameters or return values change

- **`app/data/repository/tool-repository-http-impl.ts`** - HTTP implementation
  - Update imported HTTP client functions (if API endpoints change)
  - Update the field mapping logic in `mapDtoToTool()`
  - Update the field conversion logic in `buildCreateRequestPayload()` and `buildUpdateRequestPayload()`
  - Update parameter and return value handling for each method

- **`app/data/repository/tool-repository-local-storage-impl.ts`** - LocalStorage implementation
  - Update `sanitizeUserToolPayload()` to handle new fields
  - Update each method's logic to accommodate the new data structure

#### Route and Page Components
- **`app/routes/tool-useage-page.tsx`** - Tool usage page
  - Update state initialization in `handleEditClick()`
  - Update parameter passing in `handleDeleteTool()`
- **`app/routes/tool-edit-page.tsx`** - Tool edit page
  - Update data processing logic in `handleSave()`
  - Update parameter passing in `handleDeleteTool()`
  - Update related state management if new Tool fields are involved

#### Test Files
- **`app/data/repository/tool-repository-http-impl.test.ts`** - Repository tests
  - Update `buildToolDto()` function to include new fields
  - Update all related test cases
  - Update HTTP mock request/response data
  - Update assertions to verify new field handling

#### Predefined Tools
- **`app/tools/official/*/def.ts`** - Official tool definitions
  - Update all official tool objects to include new fields

- **`app/tools/sample/sample-tool.ts`** - Sample tool
  - Update sample tool object to include new fields

### Concrete Example: Adding the uid Field

Using the recent addition of the `uid` field as an example to illustrate the impact scope:

**Change Description**: Added a `uid` field for internal operations (update/delete), and changed the API endpoint parameter from `tool_id` to `tool_uid`

**Affected Files**:
1. `app/entity/tool.ts` - Added `uid?: string` field
2. `app/data/interface/i-tool-repository.ts` - Changed method signatures to use `toolUid` parameter
3. `app/data/repository/tool-repository-http-impl.ts` - Updated API calls and field mapping
4. `app/data/repository/tool-repository-local-storage-impl.ts` - Added uid generation and handling logic
5. `app/routes/tool-useage-page.tsx` / `app/routes/tool-edit-page.tsx` - Updated state management and API calls
6. `app/data/repository/tool-repository-http-impl.test.ts` - Updated test data and assertions
7. `app/tools/official/*/def.ts` - Added uid to all official tools
8. `app/tools/sample/sample-tool.ts` - Added uid to sample tool

### Modification Checklist

When the Tool structure changes, use the following checklist to ensure all necessary modifications are completed:

- [ ] Update the Tool interface in `app/entity/tool.ts`
- [ ] Update interface method signatures in `app/data/interface/i-tool-repository.ts`
- [ ] Update the HTTP implementation in `app/data/repository/tool-repository-http-impl.ts`
  - [ ] Check whether imported HTTP client functions need updating
  - [ ] Check field mapping in `mapDtoToTool()`
  - [ ] Check `buildCreateRequestPayload()` and `buildUpdateRequestPayload()`
  - [ ] Check parameters and return values of each method
- [ ] Update the LocalStorage implementation in `app/data/repository/tool-repository-local-storage-impl.ts`
  - [ ] Check `sanitizeUserToolPayload()` method
  - [ ] Check each method's logic
- [ ] Update route components in `app/routes/tool-useage-page.tsx` and `app/routes/tool-edit-page.tsx`
  - [ ] Check state management
  - [ ] Check API calls
  - [ ] Check data processing logic
- [ ] Update tests in `app/data/repository/tool-repository-http-impl.test.ts`
  - [ ] Update `buildToolDto()` function
  - [ ] Update all related test cases
  - [ ] Update HTTP mock data
- [ ] Update all mock and official tool definitions
  - [ ] `app/tools/official/*/def.ts`
  - [ ] `app/tools/sample/sample-tool.ts`
- [ ] Run type checking: `npx tsc --noEmit`
- [ ] Run tests: `npm test`

### Common Change Types and Corresponding Modification Scope

#### Adding a New Field
- Modify: Tool interface, Repository implementations, test data, mock tools
- Check: Whether the field needs to be handled in API requests/responses

#### Modifying a Field Type
- Modify: Tool interface, Repository field mapping, test data
- Check: Whether all places using the field need to be updated

#### Changing API Endpoints or Parameters
- Modify: Repository HTTP implementation, test mock data
- Check: Whether imported HTTP client functions have been updated

#### Changing API Response Structure
- Modify: Repository's `mapDtoToTool()` method, test data
- Check: All places that depend on the return value

#### Adding a New Repository Method
- Modify: IToolRepository interface, both Repository implementations, tests
- Check: All call sites of the method
